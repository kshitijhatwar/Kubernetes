#!/bin/bash
# Kubernetes cluster cleanup script for kubeadm-based clusters
# Run as root or with sudo

echo "[INFO] Resetting kubeadm..."
kubeadm reset -f

echo "[INFO] Stopping kubelet and container runtime..."
systemctl stop kubelet
systemctl stop containerd 2>/dev/null || systemctl stop docker 2>/dev/null

echo "[INFO] Removing Kubernetes config and data..."
rm -rf /etc/kubernetes/ \
       /var/lib/etcd \
       /var/lib/kubelet/* \
       /etc/cni/net.d \
       /var/lib/cni/ \
       /opt/cni/bin \
       ~/.kube

echo "[INFO] Flushing iptables..."
iptables -F
iptables -t nat -F
iptables -t mangle -F
iptables -X

echo "[INFO] Removing CNI network interfaces..."
ip link delete cni0 2>/dev/null
ip link delete flannel.1 2>/dev/null
ip link delete weave 2>/dev/null

echo "[INFO] Kubernetes cleanup complete on $(hostname)"
